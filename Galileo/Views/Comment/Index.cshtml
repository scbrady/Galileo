@model Galileo.ViewModels.Comments

@section styles {
    @Styles.Render("~/Content/selectize")
}

@{
    ViewBag.Title = "Home Page";
}

@foreach (var comment in Model.comments)
{
    <div class="comment">
        <h4><strong>To:</strong> @comment.recipient_id / <strong>From:</strong> @comment.commenter_id / <strong>At:</strong> @comment.created_at</h4>
        <p>@comment.comment_text</p>
    </div>
}

@using (Html.BeginForm("Create", "Comment", FormMethod.Post, new { id = "comment-form" }))
{
    @Html.AntiForgeryToken()

    @Html.HiddenFor(m => m.commenter_id)

    @Html.LabelFor(m => m.recipients)<br />
    @Html.TextBoxFor(m => m.recipients, new { id = "recipients"});

    @Html.LabelFor(m => m.comment)<br />
    @Html.TextAreaFor(m => m.comment)<br />

    <input type="submit" value="Submit">
}

@section scripts {
    @Scripts.Render("~/bundles/selectize")

    <script>
        $(function () {
            $('#recipients').selectize({
                delimeter: ',',
                persist: false,
                maxOptions: 5,
                closeAfterSelect: true,
                valueField: 'user_id',
                labelField: 'user_first_name',
                searchField: ['user_first_name', 'user_first_name', 'user_id'],
                preload: true,
                render: {
                    item: function (item, escape) {
                        return '<div>' +
                            (item.user_first_name ? '<span class="selectize-user-name">' + escape(item.user_first_name) + ' ' + escape(item.user_last_name) + '</span>' : '') +
                            (item.user_id ? '<span class="selectize-user-id">&lt;' + escape(item.user_id) + '&gt;</span>' : '') +
                        '</div>';
                    },
                    option: function (item, escape) {
                        var label = item.user_first_name + ' ' + item.user_last_name;
                        var caption = item.user_id;
                        return '<div>' +
                            '<span class="selectize-label">' + escape(label) + '</span>' +
                            '<span class="selectize-caption">' + escape(caption) + '</span>' +
                        '</div>';
                    }
                },
                load: function (query, callback) {
                    if (!query.length) return callback();

                    $.ajax({
                        url: '@Url.Content("~")Comment/Users',
                        dataType: 'json',
                        success: function (data) {
                            callback(data);
                        }
                    });
                }
            });
        });
    </script>
}